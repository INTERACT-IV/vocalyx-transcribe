# =====================================================================
# Vocalyx Transcribe - Configuration File
# =====================================================================

[CORE]
# Nom unique de cette instance de worker
instance_name = worker-01

[API]
# URL de vocalyx-api pour communiquer
# En local: http://localhost:8000
# En Docker: http://vocalyx-api:8000
url = http://localhost:8000

# Timeout des requêtes HTTP (en secondes)
timeout = 60

[CELERY]
# Configuration Celery (DOIT correspondre à vocalyx-api)
# En Docker: utiliser le nom de service (redis)
# En local: utiliser localhost ou l'IP
broker_url = redis://vocalyx-redis:6379/0
result_backend = redis://vocalyx-redis:6379/0

[REDIS_TRANSCRIPTION]
# DB Redis dédiée pour les opérations de transcription (isolation des données)
# Utilise DB 2 par défaut pour isoler des opérations Celery (DB 0)
# Format: redis://host:port/db_number
# En Docker: utiliser le nom de service (redis)
# En local: utiliser localhost ou l'IP
url = redis://vocalyx-redis:6379/2

# Compression des données JSON (réduit la mémoire et le réseau)
# true: Compresse avec gzip (économise ~60-70% de mémoire)
# false: Stocke en JSON brut (plus rapide mais plus de mémoire)
compress_data = true

# TTL par défaut pour les segments (en secondes)
# Les données expirent automatiquement après ce délai.
# Augmenté à 14400s (4h) pour éviter l'expiration pendant les longues transcriptions distribuées.
default_ttl = 14400

[WHISPER]
# Modèle Whisper à utiliser
# Options: tiny, base, small, medium, large-v3-turbo
# Recommandé: small (bon équilibre vitesse/qualité) ou large-v3-turbo (meilleure qualité)
model = /home/shinohk/code/vocalyx-all/shared/models/openai-whisper-small

# Device de calcul
# Options: cpu, cuda (GPU NVIDIA), auto
device = cpu

# Type de calcul
# Options: int8, int8_float16, float16, float32
# int8: Le plus rapide (CPU uniquement)
# float16: Bon équilibre (GPU)
compute_type = int8

# Nombre de threads CPU pour l'inférence
# Recommandé: nombre de cœurs CPU - 2
cpu_threads = 10

# Langue par défaut (forcer la langue accélère la transcription)
# Options: fr, en, es, de, it, pt, nl, etc.
# Laisser vide pour détection automatique
language = fr

[PERFORMANCE]
# Nombre de workers Celery (concurrence)
# Celery gère la concurrence, ne pas confondre avec l'ancien max_workers
# Recommandé: entre 1 et 4 selon votre CPU/GPU
max_workers = 1

# Longueur des segments audio en millisecondes (BASE)
# ⚙️ DÉCOUPAGE ADAPTATIF: La taille sera automatiquement ajustée selon le CPU:
#   - CPU faible (< 4 cores): max 25s (segments plus courts = moins de mémoire)
#   - CPU moyen (4-8 cores): max 35s (équilibre)
#   - CPU puissant (> 8 cores): 45s (segments plus longs = meilleure parallélisation)
# Le nombre de cores est détecté automatiquement au démarrage
segment_length_ms = 45000

# Activer VAD (Voice Activity Detection)
# true: Ignore les silences = plus rapide
vad_enabled = true

# Beam size pour le décodage (qualité vs vitesse)
# 1 = greedy search (plus rapide, recommandé pour CPU)
# 5 = meilleure qualité mais plus lent (recommandé pour GPU)
# Optimisé pour CPU: 1
beam_size = 1

# Best of pour le décodage (nombre de recherches parallèles)
# 1 = une seule recherche (plus rapide, recommandé pour CPU)
# 5 = meilleure qualité mais plus lent
# Optimisé pour CPU: 1
best_of = 1

# Temperature pour le sampling
# 0.0 = déterministe (recommandé)
temperature = 0.0

# Timeout de transcription en secondes
# Délai maximum pour qu'une transcription se termine avant d'être considérée comme bloquée
# Recommandé: 300s (5 minutes) pour les fichiers longs, 180s (3 minutes) pour les fichiers courts
# Augmenter si vous avez des fichiers très longs (> 30 minutes)
transcription_timeout = 300

[PATHS]
# Répertoire partagé pour les uploads (DOIT être identique à vocalyx-api)
upload_dir = /home/shinohk/code/vocalyx-all/shared/uploads

[VAD]
# VAD (Voice Activity Detection) - Paramètres pour faster-whisper 1.1.0+
# Optimisé pour CPU avec VAD intégré de faster-whisper (plus rapide que pydub)

# Seuil de probabilité de parole (0.0-1.0)
# Plus élevé = plus strict (moins de faux positifs)
# Optimisé CPU: 0.5 (équilibre vitesse/qualité)
threshold = 0.5

# Durée minimum de parole pour être considérée (en ms)
# Optimisé CPU: 250ms (balance vitesse/détection)
min_speech_duration_ms = 250

# Durée minimum de silence entre segments (en ms)
# Optimisé CPU: 500ms (plus court = plus de segments mais plus rapide)
min_silence_duration_ms = 500

# Padding ajouté autour des segments de parole (en ms)
# Optimisé CPU: 400ms (bon compromis)
speech_pad_ms = 400

[LOGGING]
# Niveau de log: DEBUG, INFO, WARNING, ERROR, CRITICAL
level = INFO

# Activer les logs dans un fichier
file_enabled = true

# Chemin du fichier de log
file_path = /home/shinohk/code/vocalyx-all/shared/logs/vocalyx-transcribe.log

# Activer les couleurs dans la console
colored = true

[DIARIZATION]
# Configuration de la diarisation des locuteurs (méthode stéréo uniquement)

# Activer la diarisation
# true: La diarisation sera disponible (chargée à la demande)
# false: La diarisation sera désactivée (économise la mémoire)
enabled = false

# PARAMÈTRES POUR DIARISATION STÉRÉO
# Méthode légère et rapide basée sur la séparation des canaux stéréo
# (canal gauche = SPEAKER_00, canal droit = SPEAKER_01)
# Aucun modèle ML requis - très rapide et efficace pour fichiers stéréo dédiés

# Seuil de silence pour la détection de voix (en dB)
# Plus élevé = plus strict (détecte moins de parole)
# Recommandé: -40 dB (équilibre)
stereo_silence_thresh = -40

# Durée minimale de parole pour être considérée (en ms)
# Recommandé: 250ms (balance vitesse/détection)
stereo_min_speech_ms = 250
